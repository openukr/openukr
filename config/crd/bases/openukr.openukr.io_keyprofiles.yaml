---
apiVersion: apiextensions.k8s.io/v1
kind: CustomResourceDefinition
metadata:
  annotations:
    controller-gen.kubebuilder.io/version: v0.17.2
  name: keyprofiles.openukr.openukr.io
spec:
  group: openukr.openukr.io
  names:
    kind: KeyProfile
    listKind: KeyProfileList
    plural: keyprofiles
    singular: keyprofile
  scope: Namespaced
  versions:
  - additionalPrinterColumns:
    - jsonPath: .status.phase
      name: Phase
      type: string
    - jsonPath: .spec.keySpec.algorithm
      name: Algorithm
      type: string
    - jsonPath: .status.currentKeyID
      name: KeyID
      type: string
    - jsonPath: .status.lastRotation
      name: LastRotation
      type: date
    - jsonPath: .metadata.creationTimestamp
      name: Age
      type: date
    name: v1alpha1
    schema:
      openAPIV3Schema:
        description: |-
          KeyProfile is the Schema for the keyprofiles API.
          It defines a declarative key identity managed by openUKR.
        properties:
          apiVersion:
            description: |-
              APIVersion defines the versioned schema of this representation of an object.
              Servers should convert recognized schemas to the latest internal value, and
              may reject unrecognized values.
              More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#resources
            type: string
          kind:
            description: |-
              Kind is a string value representing the REST resource this object represents.
              Servers may infer this from the endpoint the client submits requests to.
              Cannot be updated.
              In CamelCase.
              More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#types-kinds
            type: string
          metadata:
            type: object
          spec:
            description: KeyProfileSpec defines the desired state of a key identity
              managed by openUKR.
            properties:
              keySpec:
                description: KeySpec defines the cryptographic parameters for key
                  generation.
                properties:
                  algorithm:
                    description: Algorithm specifies the asymmetric key algorithm.
                    enum:
                    - EC
                    - RSA
                    type: string
                  allowLegacyKeySize:
                    description: |-
                      AllowLegacyKeySize permits RSA key sizes below 3072 bits.
                      RSA < 3072 is deprecated per BSI TR-02102-1 (2025) and rejected by default.
                      Set to true only for documented legacy compatibility requirements.
                      [COMP:G-1]
                    type: boolean
                  encoding:
                    default: PEM
                    description: Encoding specifies the key encoding format.
                    enum:
                    - PEM
                    - DER
                    - JWK
                    type: string
                  params:
                    additionalProperties:
                      type: string
                    description: |-
                      Params holds algorithm-specific parameters.
                      For EC: {"curve": "P-256"|"P-384"|"P-521"}
                      For RSA: {"keySize": "2048"|"3072"|"4096"}
                    type: object
                required:
                - algorithm
                - params
                type: object
              output:
                description: Output defines how the generated key material is stored
                  as a Kubernetes Secret.
                properties:
                  format:
                    default: split-pem
                    description: Format defines the Secret data layout.
                    enum:
                    - split-pem
                    - bundle-json
                    - jwks
                    type: string
                  labels:
                    additionalProperties:
                      type: string
                    description: Labels are additional labels applied to the managed
                      Secret.
                    type: object
                  secretName:
                    description: SecretName is the name of the Kubernetes Secret to
                      create/update.
                    minLength: 1
                    type: string
                required:
                - secretName
                type: object
              publish:
                description: Publish defines optional targets where public keys are
                  published.
                items:
                  description: PublishTarget defines a target where the public key
                    is published.
                  properties:
                    config:
                      additionalProperties:
                        type: string
                      description: |-
                        Config holds publisher-specific configuration.
                        For http: {"endpoint": "https://..."}
                        For filesystem: {"path": "/var/keys/"}
                      type: object
                    tls:
                      description: |-
                        TLS configures transport security for HTTP publishers.
                        [SEC:T-2]
                      properties:
                        caCertSecretRef:
                          description: CACertSecretRef references a Kubernetes Secret
                            containing the CA certificate bundle.
                          type: string
                        clientCertSecretRef:
                          description: ClientCertSecretRef references a Kubernetes
                            Secret containing the mTLS client certificate.
                          type: string
                        insecureSkipVerify:
                          description: |-
                            InsecureSkipVerify disables TLS certificate verification.
                            WARNING: Must be false in production environments.
                          type: boolean
                      required:
                      - caCertSecretRef
                      type: object
                    type:
                      description: Type specifies the publisher implementation.
                      enum:
                      - http
                      - filesystem
                      type: string
                  required:
                  - config
                  - type
                  type: object
                type: array
              rotation:
                description: Rotation defines the rotation policy for this key identity.
                properties:
                  gracePeriod:
                    description: |-
                      GracePeriod specifies how long the previous key remains valid after rotation.
                      Must be at least 5 minutes (NIST SP 800-57).
                      [COMP:G-4]
                    type: string
                  interval:
                    description: |-
                      Interval specifies how often the key is rotated.
                      Must be at least 3Ã— GracePeriod.
                    type: string
                  triggerOnStartup:
                    description: TriggerOnStartup forces an immediate rotation when
                      the controller starts.
                    type: boolean
                required:
                - gracePeriod
                - interval
                type: object
              serviceAccountRef:
                description: ServiceAccountRef identifies the Kubernetes ServiceAccount
                  this key identity is bound to.
                properties:
                  name:
                    description: Name of the ServiceAccount.
                    minLength: 1
                    type: string
                  namespace:
                    description: Namespace of the ServiceAccount. Must match the KeyProfile's
                      namespace (enforced by webhook).
                    minLength: 1
                    type: string
                required:
                - name
                - namespace
                type: object
            required:
            - keySpec
            - output
            - rotation
            - serviceAccountRef
            type: object
          status:
            description: KeyProfileStatus defines the observed state of a KeyProfile.
            properties:
              conditions:
                description: Conditions represent the latest available observations
                  of the KeyProfile's state.
                items:
                  description: Condition contains details for one aspect of the current
                    state of this API Resource.
                  properties:
                    lastTransitionTime:
                      description: |-
                        lastTransitionTime is the last time the condition transitioned from one status to another.
                        This should be when the underlying condition changed.  If that is not known, then using the time when the API field changed is acceptable.
                      format: date-time
                      type: string
                    message:
                      description: |-
                        message is a human readable message indicating details about the transition.
                        This may be an empty string.
                      maxLength: 32768
                      type: string
                    observedGeneration:
                      description: |-
                        observedGeneration represents the .metadata.generation that the condition was set based upon.
                        For instance, if .metadata.generation is currently 12, but the .status.conditions[x].observedGeneration is 9, the condition is out of date
                        with respect to the current state of the instance.
                      format: int64
                      minimum: 0
                      type: integer
                    reason:
                      description: |-
                        reason contains a programmatic identifier indicating the reason for the condition's last transition.
                        Producers of specific condition types may define expected values and meanings for this field,
                        and whether the values are considered a guaranteed API.
                        The value should be a CamelCase string.
                        This field may not be empty.
                      maxLength: 1024
                      minLength: 1
                      pattern: ^[A-Za-z]([A-Za-z0-9_,:]*[A-Za-z0-9_])?$
                      type: string
                    status:
                      description: status of the condition, one of True, False, Unknown.
                      enum:
                      - "True"
                      - "False"
                      - Unknown
                      type: string
                    type:
                      description: type of condition in CamelCase or in foo.example.com/CamelCase.
                      maxLength: 316
                      pattern: ^([a-z0-9]([-a-z0-9]*[a-z0-9])?(\.[a-z0-9]([-a-z0-9]*[a-z0-9])?)*/)?(([A-Za-z0-9][-A-Za-z0-9_.]*)?[A-Za-z0-9])$
                      type: string
                  required:
                  - lastTransitionTime
                  - message
                  - reason
                  - status
                  - type
                  type: object
                type: array
              currentKeyFingerprint:
                description: |-
                  CurrentKeyFingerprint is the SHA-256 fingerprint of the current key's public component.
                  Used for integrity verification against Secret tampering.
                  [SEC:T-1]
                type: string
              currentKeyID:
                description: CurrentKeyID is the identifier of the currently active
                  key.
                type: string
              lastRotation:
                description: LastRotation is the timestamp of the last successful
                  rotation.
                format: date-time
                type: string
              nextRotation:
                description: NextRotation is the timestamp of the next scheduled rotation.
                format: date-time
                type: string
              phase:
                description: Phase indicates the current rotation phase.
                enum:
                - Idle
                - Active
                - Generating
                - Publishing
                - Distributing
                - GracePeriod
                - Error
                type: string
              previousKeyFingerprint:
                description: |-
                  PreviousKeyFingerprint is the SHA-256 fingerprint of the previous key's public component.
                  [SEC:T-1]
                type: string
              previousKeyID:
                description: PreviousKeyID is the identifier of the previous key (during
                  grace period).
                type: string
            type: object
        type: object
    served: true
    storage: true
    subresources:
      status: {}
